<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Customizer for Karen</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #e0e0e0;
            position: relative;
            overflow: auto;
            max-height: 100vh;
        }

        #character-canvas {
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .controls-panel {
            width: 340px;
            height: 100vh;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        h1, h2 {
            color: #333;
            text-align: center;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        select, button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            margin-top: 8px;
        }

        .color-picker-label {
            margin-right: 10px;
            min-width: 70px;
        }

        .color-picker {
            height: 30px;
            width: 60px;
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .download-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            z-index: 10;
            width: auto;
        }

        .download-btn:hover {
            background-color: #0b7dda;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }

        .loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4CAF50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <h2>Loading character data...</h2>
    </div>

    <div class="canvas-container">
        <canvas id="character-canvas" width="2160" height="3840"></canvas>
        <button class="download-btn" id="download-btn">Download Character</button>
    </div>

    <div class="controls-panel">
        <h1>Character Customizer</h1>
        <p style="text-align: center;">A special gift for Karen!</p>

        <div class="section">
            <h2>Body Poses</h2>
            <div id="bodyparts-container">
                <!-- Bodyparts controls will be added here dynamically -->
            </div>
        </div>

        <div class="section">
            <h2>Clothing & Features</h2>
            <div id="clothing-container">
                <!-- Clothing controls will be added here dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let characterData = [];
        let loadedImages = {};
        const canvas = document.getElementById('character-canvas');
        const ctx = canvas.getContext('2d');
        
        // Current state
        let currentState = {
            bodyparts: {
                torso: '01',
                head: '01',
                larm: '01',
                rarm: '01',
                lleg: '01',
                rleg: '01'
            },
            clothing: {
                shirt: { active: true, variant: '01', color: '#000000' },
                hair: { active: true, variant: '01', color: '#000000' },
                face: { active: true, variant: '01', color: '#000000' },
                jacket: { active: false, variant: '01', color: '#000000' },
                pants: { active: true, variant: '01', color: '#000000' },
                lshoe: { active: true, variant: '01', color: '#000000' },
                rshoe: { active: true, variant: '01', color: '#000000' }
            }
        };

        // Dependencies mapping
        const dependencies = {
            shirt: ['larm', 'rarm'],
            jacket: ['larm', 'rarm'],
            pants: ['lleg', 'rleg'],
            hair: ['head'],
            face: ['head'],
            lshoe: ['lleg'],
            rshoe: ['rleg']
        };

        // Variations count
        const variations = {
            bodyparts: {
                torso: 1,
                head: 3,
                larm: 4,
                rarm: 4,
                lleg: 4,
                rleg: 4
            },
            clothing: {
                shirt: 3,
                hair: 2,
                face: 6,
                jacket: 2,
                pants: 3,
                lshoe: 3,
                rshoe: 3
            }
        };

        // Initialize the app
        window.onload = async function() {
            try {
                // Load CSV data
                await loadCharacterData();
                
                // Setup UI controls
                setupBodypartControls();
                setupClothingControls();
                
                // Setup download button
                document.getElementById('download-btn').addEventListener('click', downloadCharacter);
                
                // Initial render
                renderCharacter();
                
                // Hide loading screen
                document.getElementById('loading-screen').style.display = 'none';
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to initialize the app. Please check the console for details.');
            }
        };

        // Load character data from CSV
        async function loadCharacterData() {
            try {
                const response = await fetch('character_data.csv');
                const csvText = await response.text();
                
                // Parse CSV
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = lines[i].split(',');
                    const item = {};
                    
                    headers.forEach((header, index) => {
                        item[header.trim()] = values[index]?.trim() || '';
                    });
                    
                    characterData.push(item);
                }
                
                console.log('Character data loaded:', characterData.length, 'items');
            } catch (error) {
                console.error('Error loading character data:', error);
                throw error;
            }
        }

        // Setup bodypart controls
        function setupBodypartControls() {
            const container = document.getElementById('bodyparts-container');
            
            for (const part in variations.bodyparts) {
                const maxVariation = variations.bodyparts[part];
                
                const controlGroup = document.createElement('div');
                controlGroup.className = 'control-group';
                
                const label = document.createElement('label');
                label.textContent = formatLabel(part);
                controlGroup.appendChild(label);
                
                const select = document.createElement('select');
                select.id = `${part}-select`;
                
                for (let i = 1; i <= maxVariation; i++) {
                    const option = document.createElement('option');
                    const varNum = i.toString().padStart(2, '0');
                    option.value = varNum;
                    option.textContent = `Pose ${i}`;
                    select.appendChild(option);
                }
                
                select.addEventListener('change', (e) => {
                    currentState.bodyparts[part] = e.target.value;
                    renderCharacter();
                });
                
                controlGroup.appendChild(select);
                container.appendChild(controlGroup);
            }
        }

        // Setup clothing controls
        function setupClothingControls() {
            const container = document.getElementById('clothing-container');
            
            for (const item in variations.clothing) {
                const maxVariation = variations.clothing[item];
                
                const controlGroup = document.createElement('div');
                controlGroup.className = 'control-group';
                
                // Toggle switch
                const toggleContainer = document.createElement('div');
                toggleContainer.className = 'toggle-container';
                
                const toggleLabel = document.createElement('span');
                toggleLabel.textContent = formatLabel(item);
                
                const toggleSwitch = document.createElement('label');
                toggleSwitch.className = 'toggle-switch';
                
                const toggleInput = document.createElement('input');
                toggleInput.type = 'checkbox';
                toggleInput.checked = currentState.clothing[item].active;
                toggleInput.addEventListener('change', (e) => {
                    currentState.clothing[item].active = e.target.checked;
                    renderCharacter();
                });
                
                const slider = document.createElement('span');
                slider.className = 'slider';
                
                toggleSwitch.appendChild(toggleInput);
                toggleSwitch.appendChild(slider);
                toggleContainer.appendChild(toggleSwitch);
                toggleContainer.appendChild(toggleLabel);
                controlGroup.appendChild(toggleContainer);
                
                // Variant select
                const select = document.createElement('select');
                select.id = `${item}-select`;
                
                for (let i = 1; i <= maxVariation; i++) {
                    const option = document.createElement('option');
                    const varNum = i.toString().padStart(2, '0');
                    option.value = varNum;
                    option.textContent = `Style ${i}`;
                    select.appendChild(option);
                }
                
                select.addEventListener('change', (e) => {
                    currentState.clothing[item].variant = e.target.value;
                    renderCharacter();
                });
                
                controlGroup.appendChild(select);
                
                // Color picker (if applicable)
                const colorPickerContainer = document.createElement('div');
                colorPickerContainer.className = 'color-picker-container';
                
                const colorLabel = document.createElement('span');
                colorLabel.className = 'color-picker-label';
                colorLabel.textContent = 'Color:';
                
                const colorPicker = document.createElement('input');
                colorPicker.type = 'color';
                colorPicker.className = 'color-picker';
                colorPicker.value = currentState.clothing[item].color;
                colorPicker.addEventListener('input', (e) => {
                    currentState.clothing[item].color = e.target.value;
                    renderCharacter();
                });
                
                colorPickerContainer.appendChild(colorLabel);
                colorPickerContainer.appendChild(colorPicker);
                controlGroup.appendChild(colorPickerContainer);
                
                container.appendChild(controlGroup);
            }
        }

        // Render character based on current state
        async function renderCharacter() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Get all relevant parts to display based on current state
            const partsToRender = [];
            
            // Add bodyparts
            for (const part in currentState.bodyparts) {
                const variation = currentState.bodyparts[part];
                const filename = `${part}_${variation}`;
                
                const matchingParts = characterData.filter(item => 
                    item.filename === filename || item.filename.startsWith(filename)
                );
                
                matchingParts.forEach(part => {
                    partsToRender.push(part);
                });
            }
            
            // Add clothing
            for (const item in currentState.clothing) {
                if (!currentState.clothing[item].active) continue;
                
                const variant = currentState.clothing[item].variant;
                const deps = dependencies[item];
                const depValues = deps.map(dep => currentState.bodyparts[dep]);
                
                // Create the filename pattern to match
                let filenamePattern = `${item}_${variant}`;
                deps.forEach((dep, index) => {
                    filenamePattern += `_${depValues[index]}`;
                });
                
                // Find matching parts
                const matchingParts = characterData.filter(part => 
                    part.filename.startsWith(filenamePattern)
                );
                
                matchingParts.forEach(part => {
                    partsToRender.push(part);
                });
            }
            
            // Sort by layer
            partsToRender.sort((a, b) => parseInt(a.layer) - parseInt(b.layer));
            
            // Load and draw images
            for (const part of partsToRender) {
                const filename = part.filename;
                const imagePath = `images/${filename}.png`;
                
                // Load image if not already loaded
                if (!loadedImages[imagePath]) {
                    try {
                        loadedImages[imagePath] = await loadImage(imagePath);
                    } catch (error) {
                        console.error(`Failed to load image: ${imagePath}`, error);
                        continue;
                    }
                }
                
                const img = loadedImages[imagePath];
                
                // Check if this is a color part
                if (part.color === 'TRUE') {
                    // Get the clothing type from the filename
                    const clothingType = filename.split('_')[0];
                    const selectedColor = currentState.clothing[clothingType].color;
                    
                    // Draw with color
                    drawImageWithColor(img, selectedColor);
                } else {
                    // Draw normally
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                }
            }
        }

        // Helper function to load an image
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`Failed to load image: ${src}`));
                img.src = src;
            });
        }

        // Helper function to draw an image with color tint
        function drawImageWithColor(img, color) {
            // Create a temporary canvas for manipulation
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Draw the original image to the temp canvas
            tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
            
            // Get the image data
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;
            
            // Convert hex color to RGB
            const r = parseInt(color.slice(1, 3), 16);
            const g = parseInt(color.slice(3, 5), 16);
            const b = parseInt(color.slice(5, 7), 16);
            
            // Apply the color tint (multiply)
            for (let i = 0; i < data.length; i += 4) {
                // Skip if pixel is fully transparent
                if (data[i + 3] === 0) continue;
                
                // The image is black and white, so we use the same value for R, G, B
                // Normalize grayscale value to 0-1 range
                const grayValue = data[i] / 255;
                
                // Apply the tint by multiplying the color
                data[i] = Math.round(r * grayValue);
                data[i + 1] = Math.round(g * grayValue);
                data[i + 2] = Math.round(b * grayValue);
            }
            
            // Put the modified image data back on the temp canvas
            tempCtx.putImageData(imageData, 0, 0);
            
            // Draw the tinted image to the main canvas
            ctx.drawImage(tempCanvas, 0, 0);
        }

        // Download the character as PNG
        function downloadCharacter() {
            const link = document.createElement('a');
            link.download = 'my-character.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // Helper function to format labels
        function formatLabel(str) {
            // Convert larm to Left Arm, rleg to Right Leg, etc.
            if (str === 'larm') return 'Left Arm';
            if (str === 'rarm') return 'Right Arm';
            if (str === 'lleg') return 'Left Leg';
            if (str === 'rleg') return 'Right Leg';
            if (str === 'lshoe') return 'Left Shoe';
            if (str === 'rshoe') return 'Right Shoe';
            
            // Capitalize first letter
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    </script>
</body>
</html>
