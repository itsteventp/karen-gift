<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Customizer for Karen</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #e0e0e0;
            position: relative;
            overflow: auto;
            max-height: 100vh;
            padding: 20px;
        }

        .canvas-wrapper {
            position: relative;
            height: calc(100vh - 40px);
            display: flex;
            justify-content: center;
            align-items: center;
        }
    
        #character-canvas {
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
            width: auto;
            height: auto;
        }

        .controls-panel {
            width: 340px;
            height: 100vh;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        h1, h2 {
            color: #333;
            text-align: center;
            margin-top: 0;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .control-group {
            margin-bottom: 20px; /* Increased spacing */
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            font-size: 14px;
            margin-bottom: 12px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px auto;
        }

        select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-size: 15px;
        }

        button:hover {
            background-color: #45a049;
        }
    
        button:active {
            transform: scale(0.98);
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            margin-top: 12px;
        }

        .color-picker-label {
            margin-right: 15px;
            min-width: 70px;
            font-weight: 500;
        }

        .color-picker {
            height: 35px;
            width: 70px;
            padding: 0;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: none;
            cursor: pointer;
            transition: border-color 0.3s;
        }
    
        .color-picker:hover {
            border-color: #aaa;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 5px 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 15px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
            box-shadow: inset 0 0 3px rgba(0,0,0,0.2);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .download-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            padding: 12px 24px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            z-index: 10;
            width: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
        }

        .download-btn:hover {
            background-color: #0b7dda;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
    
        .download-btn:active {
            transform: scale(0.98) translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }

        .loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4CAF50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
    
        .loading-message {
            margin-top: 10px;
            color: #333;
        }

        #error-msg {
            color: red;
            max-width: 80%;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Add this for mobile responsiveness */
        @media (max-width: 1200px) {
            body {
                flex-direction: column;
            }
        
            .canvas-container {
                height: 60vh;
                max-height: 60vh;
            }
         
            .controls-panel {
                width: 100%;
                height: 40vh;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <h2>Loading character data...</h2>
    </div>

    <div class="canvas-container">
        <div class="canvas-wrapper">
            <canvas id="character-canvas" width="2160" height="3840"></canvas>
        </div>
        <button class="download-btn" id="download-btn">Download Character</button>
    </div>

    <div class="controls-panel">
        <h1>Character Customizer</h1>
        <p style="text-align: center;">A special gift for Karen!</p>

        <div class="section">
            <h2>Body Poses</h2>
            <div id="bodyparts-container">
                <!-- Bodyparts controls will be added here dynamically -->
            </div>
        </div>

        <div class="section">
            <h2>Clothing & Features</h2>
            <div id="clothing-container">
                <!-- Clothing controls will be added here dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let characterData = [];
        let loadedImages = {};
        const canvas = document.getElementById('character-canvas');
        const ctx = canvas.getContext('2d');
        
        // Current state
        let currentState = {
            bodyparts: {
                torso: '01',
                head: '01',
                larm: '01',
                rarm: '01',
                lleg: '01',
                rleg: '01'
            },
            clothing: {
                shirt: { active: true, variant: '01', color: '#000000' },
                hair: { active: true, variant: '01', color: '#000000' },
                face: { active: true, variant: '01', color: '#000000' },
                jacket: { active: false, variant: '01', color: '#000000' },
                pants: { active: true, variant: '01', color: '#000000' },
                lshoe: { active: true, variant: '01', color: '#000000' },
                rshoe: { active: true, variant: '01', color: '#000000' }
            }
        };

        // Dependencies mapping
        const dependencies = {
            shirt: ['larm', 'rarm'],
            jacket: ['larm', 'rarm'],
            pants: ['lleg', 'rleg'],
            hair: ['head'],
            face: ['head'],
            lshoe: ['lleg'],
            rshoe: ['rleg']
        };

        // Variations count
        const variations = {
            bodyparts: {
                torso: 1,
                head: 3,
                larm: 4,
                rarm: 4,
                lleg: 4,
                rleg: 4
            },
            clothing: {
                shirt: 3,
                hair: 2,
                face: 6,
                jacket: 2,
                pants: 3,
                lshoe: 3,
                rshoe: 3
            }
        };

        // Initialize the app
        window.onload = async function() {
            try {
                // Load CSV data
                await loadCharacterData();
                
                // Setup UI controls
                setupBodypartControls();
                setupClothingControls();
                
                // Setup download button
                document.getElementById('download-btn').addEventListener('click', downloadCharacter);
                
                // Initial render
                renderCharacter();
                
                // Hide loading screen
                document.getElementById('loading-screen').style.display = 'none';
                setupCanvasScaling();
            } catch (error) {
                console.error('Initialization error:', error);
                errorMsg.textContent = 'Failed to initialize: ' + error.message;
            }
        };

        // Load character data from CSV
        async function loadCharacterData() {
            try {
                const response = await fetch('character_data.csv');
                const csvText = await response.text();
                
                // Parse CSV
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = lines[i].split(',');
                    const item = {};
                    
                    headers.forEach((header, index) => {
                        item[header.trim()] = values[index]?.trim() || '';
                    });
                    
                    characterData.push(item);
                }
                
                console.log('Character data loaded:', characterData.length, 'items');
            } catch (error) {
                console.error('Error loading character data:', error);
                throw error;
            }
        }

        // Setup bodypart controls
        function setupBodypartControls() {
            const container = document.getElementById('bodyparts-container');
            
            for (const part in variations.bodyparts) {
                const maxVariation = variations.bodyparts[part];
                
                const controlGroup = document.createElement('div');
                controlGroup.className = 'control-group';
                
                const label = document.createElement('label');
                label.textContent = formatLabel(part);
                controlGroup.appendChild(label);
                
                const select = document.createElement('select');
                select.id = `${part}-select`;
                
                for (let i = 1; i <= maxVariation; i++) {
                    const option = document.createElement('option');
                    const varNum = i.toString().padStart(2, '0');
                    option.value = varNum;
                    option.textContent = `Pose ${i}`;
                    select.appendChild(option);
                }
                
                select.addEventListener('change', (e) => {
                    currentState.bodyparts[part] = e.target.value;
                    renderCharacter();
                });
                
                controlGroup.appendChild(select);
                container.appendChild(controlGroup);
            }
        }

        // Setup clothing controls
        function setupClothingControls() {
            const container = document.getElementById('clothing-container');
            container.innerHTML = '';
            
            for (const item in variations.clothing) {
                const maxVariation = variations.clothing[item];
                
                const controlGroup = document.createElement('div');
                controlGroup.className = 'control-group';
                
                // Toggle switch
                const toggleContainer = document.createElement('div');
                toggleContainer.className = 'toggle-container';
                
                const toggleLabel = document.createElement('span');
                toggleLabel.textContent = formatLabel(item);
                
                const toggleSwitch = document.createElement('label');
                toggleSwitch.className = 'toggle-switch';
                
                const toggleInput = document.createElement('input');
                toggleInput.type = 'checkbox';
                toggleInput.checked = currentState.clothing[item].active;
                toggleInput.addEventListener('change', (e) => {
                    currentState.clothing[item].active = e.target.checked;
                    renderCharacter();
                });
                
                const slider = document.createElement('span');
                slider.className = 'slider';
                
                toggleSwitch.appendChild(toggleInput);
                toggleSwitch.appendChild(slider);
                toggleContainer.appendChild(toggleSwitch);
                toggleContainer.appendChild(toggleLabel);
                controlGroup.appendChild(toggleContainer);
                
                // Variant select
                const select = document.createElement('select');
                select.id = `${item}-select`;
                
                for (let i = 1; i <= maxVariation; i++) {
                    const option = document.createElement('option');
                    const varNum = i.toString().padStart(2, '0');
                    option.value = varNum;
                    option.textContent = `Style ${i}`;
                    select.appendChild(option);
                }
                
                select.addEventListener('change', (e) => {
                    currentState.clothing[item].variant = e.target.value;
                    renderCharacter();
                });
                
                controlGroup.appendChild(select);
                
                // Color picker (if applicable)
                const colorPickerContainer = document.createElement('div');
                colorPickerContainer.className = 'color-picker-container';
                
                const colorLabel = document.createElement('span');
                colorLabel.className = 'color-picker-label';
                colorLabel.textContent = 'Color:';
                
                const colorPicker = document.createElement('input');
                colorPicker.type = 'color';
                colorPicker.className = 'color-picker';
                colorPicker.value = currentState.clothing[item].color;
                colorPicker.addEventListener('input', (e) => {
                    currentState.clothing[item].color = e.target.value;
                    renderCharacter();
                });
                
                colorPickerContainer.appendChild(colorLabel);
                colorPickerContainer.appendChild(colorPicker);
                controlGroup.appendChild(colorPickerContainer);
                
                container.appendChild(controlGroup);
            }
        }

        // Render character based on current state
        async function renderCharacter() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Get all relevant parts to display based on current state
            const partsToRender = [];
            
            // Add bodyparts
            for (const part in currentState.bodyparts) {
                const variation = currentState.bodyparts[part];
                const filename = `${part}_${variation}`;
                
                const matchingParts = characterData.filter(item => 
                    item.filename === filename || item.filename.startsWith(filename)
                );
                
                matchingParts.forEach(part => {
                    partsToRender.push(part);
                });
            }
            
            // Add clothing
            for (const item in currentState.clothing) {
                if (!currentState.clothing[item].active) continue;
                
                const variant = currentState.clothing[item].variant;
                const deps = dependencies[item];
                const depValues = deps.map(dep => currentState.bodyparts[dep]);
                
                // Create the filename pattern to match
                let filenamePattern = `${item}_${variant}`;
                deps.forEach((dep, index) => {
                    filenamePattern += `_${depValues[index]}`;
                });
                
                // Find matching parts
                const matchingParts = characterData.filter(part => 
                    part.filename.startsWith(filenamePattern)
                );
                
                matchingParts.forEach(part => {
                    partsToRender.push(part);
                });
            }
            
            // Sort by layer
            partsToRender.sort((a, b) => parseInt(a.layer) - parseInt(b.layer));
            
            // Load and draw images
            for (const part of partsToRender) {
                const filename = part.filename;
                const imagePath = `images/${filename}`;
                
                // Load image if not already loaded
                if (!loadedImages[imagePath]) {
                    try {
                        loadedImages[imagePath] = await loadImage(imagePath);
                    } catch (error) {
                        console.error(`Failed to load image: ${imagePath}`, error);
                        continue;
                    }
                }
                
                const img = loadedImages[imagePath];
                
                // Check if this is a color part
                if (part.color === 'TRUE') {
                    // Get the clothing type from the filename
                    const clothingType = filename.split('_')[0];
                    const selectedColor = currentState.clothing[clothingType].color;
                    
                    // Draw with color
                    drawImageWithColor(img, selectedColor);
                } else {
                    // Draw normally
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                }
            }
        }

        // Helper function to load an image
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`Failed to load image: ${src}`));
                img.src = src;
            });
        }

        // Helper function to draw an image with color tint
        // Replace your current drawImageWithColor function with this one:
        function drawImageWithColor(img, color) {
            try {
                // Create a temporary canvas for manipulation
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
        
                // Draw the original image to the temp canvas
                tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
        
                // Get the image data
                const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imageData.data;
            
                // Convert hex color to RGB
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
        
                // Apply the color tint (multiply)
                for (let i = 0; i < data.length; i += 4) {
                    // Skip if pixel is transparent (alpha = 0)
                    if (data[i + 3] === 0) continue;
            
                    // Calculate grayscale value - use average of RGB for better accuracy
                    // This helps if the image isn't perfectly grayscale
                    const grayValue = (data[i] + data[i + 1] + data[i + 2]) / (3 * 255);
            
                    // Apply the tint by multiplying the color
                    data[i] = Math.round(r * grayValue);       // Red
                    data[i + 1] = Math.round(g * grayValue);   // Green
                    data[i + 2] = Math.round(b * grayValue);   // Blue
                    // Keep original alpha
                }
        
                // Put the modified image data back on the temp canvas
                tempCtx.putImageData(imageData, 0, 0);
        
                // Draw the tinted image to the main canvas
                ctx.drawImage(tempCanvas, 0, 0);
            } catch (error) {
                console.error('Error applying color tint:', error);
            }
        }

        // Download the character as PNG
        function downloadCharacter() {
            const link = document.createElement('a');
            link.download = 'my-character.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // Helper function to format labels
        function formatLabel(str) {
            // Convert larm to Left Arm, rleg to Right Leg, etc.
            if (str === 'larm') return 'Left Arm';
            if (str === 'rarm') return 'Right Arm';
            if (str === 'lleg') return 'Left Leg';
            if (str === 'rleg') return 'Right Leg';
            if (str === 'lshoe') return 'Left Shoe';
            if (str === 'rshoe') return 'Right Shoe';
            
            // Capitalize first letter
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        function setupCanvasScaling() {
            const canvasWrapper = document.querySelector('.canvas-wrapper');
            const canvas = document.getElementById('character-canvas');
    
            // Function to resize canvas
            function resizeCanvas() {
                const wrapperHeight = canvasWrapper.clientHeight;
                const wrapperWidth = canvasWrapper.clientWidth;
        
                // Original aspect ratio 9:16
                const aspectRatio = 2160 / 3840;
        
                let displayWidth, displayHeight;
        
                // If wrapper is taller than canvas aspect ratio
                if (wrapperWidth / wrapperHeight > aspectRatio) {
                    // Constrain by height
                    displayHeight = wrapperHeight;
                    displayWidth = wrapperHeight * aspectRatio;
                } else {
                    // Constrain by width
                    displayWidth = wrapperWidth;
                    displayHeight = wrapperWidth / aspectRatio;
                }
        
                // Apply scale transformation to canvas
                canvas.style.width = `${displayWidth}px`;
                canvas.style.height = `${displayHeight}px`;
        
                console.log(`Canvas scaled to: ${displayWidth}px Ã— ${displayHeight}px`);
            }
    
            // Initial resize
            resizeCanvas();
    
            // Resize on window change
            window.addEventListener('resize', resizeCanvas);
        }
    </script>
</body>
</html>
